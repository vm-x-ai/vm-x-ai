{{- if and (eq (default "create" .Values.secrets.database.method) "eso") .Values.secrets.externalSecrets.enabled }}
{{- $secretStoreName := .Values.secrets.externalSecrets.secretStore.name }}
{{- $secretStoreKind := .Values.secrets.externalSecrets.secretStore.kind }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-database
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ $secretStoreName }}
    kind: {{ $secretStoreKind }}
  target:
    name: {{ include "vm-x-ai.fullname" . }}-database
    creationPolicy: Owner
  data:
    - secretKey: {{ .Values.secrets.database.externalSecrets.passwordKey }}
      remoteRef:
        key: {{ .Values.secrets.database.externalSecrets.secretKey }}
        property: {{ .Values.secrets.database.externalSecrets.passwordKey }}
    {{- if not .Values.postgresql.enabled }}
    - secretKey: {{ .Values.secrets.database.externalSecrets.hostKey }}
      remoteRef:
        key: {{ .Values.secrets.database.externalSecrets.secretKey }}
        property: {{ .Values.secrets.database.externalSecrets.hostKey }}
    - secretKey: {{ .Values.secrets.database.externalSecrets.portKey }}
      remoteRef:
        key: {{ .Values.secrets.database.externalSecrets.secretKey }}
        property: {{ .Values.secrets.database.externalSecrets.portKey }}
    - secretKey: {{ .Values.secrets.database.externalSecrets.databaseKey }}
      remoteRef:
        key: {{ .Values.secrets.database.externalSecrets.secretKey }}
        property: {{ .Values.secrets.database.externalSecrets.databaseKey }}
    - secretKey: {{ .Values.secrets.database.externalSecrets.usernameKey }}
      remoteRef:
        key: {{ .Values.secrets.database.externalSecrets.secretKey }}
        property: {{ .Values.secrets.database.externalSecrets.usernameKey }}
    {{- end }}
---
{{- end }}
{{- if and (eq (default "create" .Values.secrets.questdb.method) "eso") .Values.secrets.externalSecrets.enabled }}
{{- $secretStoreName := .Values.secrets.externalSecrets.secretStore.name }}
{{- $secretStoreKind := .Values.secrets.externalSecrets.secretStore.kind }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-questdb
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ $secretStoreName }}
    kind: {{ $secretStoreKind }}
  target:
    name: {{ include "vm-x-ai.fullname" . }}-questdb
    creationPolicy: Owner
  data:
    - secretKey: {{ .Values.secrets.questdb.externalSecrets.passwordKey }}
      remoteRef:
        key: {{ .Values.secrets.questdb.externalSecrets.secretKey }}
        property: {{ .Values.secrets.questdb.externalSecrets.passwordKey }}
    {{- if not .Values.questdb.enabled }}
    - secretKey: {{ .Values.secrets.questdb.externalSecrets.hostKey }}
      remoteRef:
        key: {{ .Values.secrets.questdb.externalSecrets.secretKey }}
        property: {{ .Values.secrets.questdb.externalSecrets.hostKey }}
    - secretKey: {{ .Values.secrets.questdb.externalSecrets.portKey }}
      remoteRef:
        key: {{ .Values.secrets.questdb.externalSecrets.secretKey }}
        property: {{ .Values.secrets.questdb.externalSecrets.portKey }}
    - secretKey: {{ .Values.secrets.questdb.externalSecrets.databaseKey }}
      remoteRef:
        key: {{ .Values.secrets.questdb.externalSecrets.secretKey }}
        property: {{ .Values.secrets.questdb.externalSecrets.databaseKey }}
    - secretKey: {{ .Values.secrets.questdb.externalSecrets.usernameKey }}
      remoteRef:
        key: {{ .Values.secrets.questdb.externalSecrets.secretKey }}
        property: {{ .Values.secrets.questdb.externalSecrets.usernameKey }}
    {{- end }}
---
{{- end }}
{{- if and (eq .Values.api.encryption.provider "libsodium") (eq (default "create" .Values.secrets.libsodium.method) "eso") .Values.secrets.externalSecrets.enabled }}
{{- $secretStoreName := .Values.secrets.externalSecrets.secretStore.name }}
{{- $secretStoreKind := .Values.secrets.externalSecrets.secretStore.kind }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-libsodium
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ $secretStoreName }}
    kind: {{ $secretStoreKind }}
  target:
    name: {{ include "vm-x-ai.fullname" . }}-libsodium
    creationPolicy: Owner
  data:
    - secretKey: {{ .Values.secrets.libsodium.externalSecrets.encryptionKeyKey }}
      remoteRef:
        key: {{ .Values.secrets.libsodium.externalSecrets.secretKey }}
        property: {{ .Values.secrets.libsodium.externalSecrets.encryptionKeyKey }}
---
{{- end }}
{{- if and (eq (default "create" .Values.secrets.ui.method) "eso") .Values.secrets.externalSecrets.enabled }}
{{- $secretStoreName := .Values.secrets.externalSecrets.secretStore.name }}
{{- $secretStoreKind := .Values.secrets.externalSecrets.secretStore.kind }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-ui
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ $secretStoreName }}
    kind: {{ $secretStoreKind }}
  target:
    name: {{ include "vm-x-ai.fullname" . }}-ui
    creationPolicy: Owner
  data:
    - secretKey: {{ .Values.secrets.ui.externalSecrets.authSecretKey }}
      remoteRef:
        key: {{ .Values.secrets.ui.externalSecrets.secretKey }}
        property: {{ .Values.secrets.ui.externalSecrets.authSecretKey }}
---
{{- end }}
{{- if and (eq (default "create" .Values.secrets.oidcFederated.method) "eso") .Values.api.oidcFederated.enabled .Values.api.oidcFederated.clientSecret .Values.secrets.externalSecrets.enabled }}
{{- $secretStoreName := .Values.secrets.externalSecrets.secretStore.name }}
{{- $secretStoreKind := .Values.secrets.externalSecrets.secretStore.kind }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-oidc-federated
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ $secretStoreName }}
    kind: {{ $secretStoreKind }}
  target:
    name: {{ include "vm-x-ai.fullname" . }}-oidc-federated
    creationPolicy: Owner
  data:
    - secretKey: {{ .Values.secrets.oidcFederated.externalSecrets.clientSecretKey }}
      remoteRef:
        key: {{ .Values.secrets.oidcFederated.externalSecrets.secretKey }}
        property: {{ .Values.secrets.oidcFederated.externalSecrets.clientSecretKey }}
---
{{- end }}
