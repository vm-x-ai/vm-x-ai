{{- if .Values.ingress.enabled }}
{{- $host := .Values.ingress.istio.host }}
{{- if not $host }}
{{- fail "ingress.istio.host must be set when ingress.enabled is true" }}
{{- end }}
{{- /* Build servers with host from ingress.istio.host */}}
{{- $servers := list }}
{{- range .Values.ingress.istio.gateway.servers }}
{{- $server := deepCopy . }}
{{- $_ := set $server "hosts" (list $host) }}
{{- $servers = append $servers $server }}
{{- end }}
{{- $virtualServiceHosts := list $host }}
---
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: {{ .Values.ingress.istio.gateway.name }}
  namespace: {{ .Values.ingress.istio.gateway.namespace }}
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
spec:
  selector:
    {{- toYaml .Values.ingress.istio.gateway.selector | nindent 4 }}
  servers:
    {{- toYaml $servers | nindent 4 }}
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: {{ include "vm-x-ai.fullname" . }}
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
spec:
  hosts:
    {{- toYaml $virtualServiceHosts | nindent 4 }}
  gateways:
    {{- toYaml .Values.ingress.istio.virtualService.gateways | nindent 4 }}
    - mesh  # Apply to internal mesh traffic as well
  http:
    # API routes (must come before UI routes for proper matching)
    {{- $basePath := .Values.api.env.BASE_PATH }}
    {{- if $basePath }}
    # Route API requests using BASE_PATH
    - match:
        - uri:
            prefix: {{ $basePath }}
      route:
        - destination:
            host: {{ include "vm-x-ai.fullname" . }}-api
            port:
              number: {{ .Values.api.service.port }}
    {{- else }}
    # Default API route when BASE_PATH is not set
    - match:
        - uri:
            prefix: /api
      route:
        - destination:
            host: {{ include "vm-x-ai.fullname" . }}-api
            port:
              number: {{ .Values.api.service.port }}
    {{- end }}
    # UI routes (catch-all)
    - match:
        - uri:
            prefix: /
      route:
        - destination:
            host: {{ include "vm-x-ai.fullname" . }}-ui
            port:
              number: {{ .Values.ui.service.port }}
{{- if and .Values.ingress.enabled .Values.ingress.istio.virtualService.trafficPolicy }}
---
# DestinationRule for API service traffic policies
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-api
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
spec:
  host: {{ include "vm-x-ai.fullname" . }}-api
  {{- with .Values.ingress.istio.virtualService.trafficPolicy }}
  trafficPolicy:
    {{- if .loadBalancer }}
    loadBalancer:
      {{- toYaml .loadBalancer | nindent 6 }}
    {{- end }}
    {{- if .connectionPool }}
    connectionPool:
      {{- toYaml .connectionPool | nindent 6 }}
    {{- end }}
    {{- if .outlierDetection }}
    outlierDetection:
      {{- toYaml .outlierDetection | nindent 6 }}
    {{- end }}
  {{- end }}
---
# DestinationRule for UI service traffic policies
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-ui
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
spec:
  host: {{ include "vm-x-ai.fullname" . }}-ui
  {{- with .Values.ingress.istio.virtualService.trafficPolicy }}
  trafficPolicy:
    {{- if .loadBalancer }}
    loadBalancer:
      {{- toYaml .loadBalancer | nindent 6 }}
    {{- end }}
    {{- if .connectionPool }}
    connectionPool:
      {{- toYaml .connectionPool | nindent 6 }}
    {{- end }}
    {{- if .outlierDetection }}
    outlierDetection:
      {{- toYaml .outlierDetection | nindent 6 }}
    {{- end }}
  {{- end }}
{{- end }}
{{- end }}
