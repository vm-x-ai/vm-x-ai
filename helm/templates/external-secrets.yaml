{{- if and (eq .Values.secrets.method "eso") .Values.secrets.externalSecrets.enabled }}
{{- $secretStoreName := .Values.secrets.externalSecrets.secretStore.name }}
{{- $secretStoreKind := .Values.secrets.externalSecrets.secretStore.kind }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-database
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ $secretStoreName }}
    kind: {{ $secretStoreKind }}
  target:
    name: {{ include "vm-x-ai.fullname" . }}-database
    creationPolicy: Owner
  data:
    - secretKey: {{ .Values.secrets.externalSecrets.database.passwordKey }}
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.database.secretKey }}
        property: {{ .Values.secrets.externalSecrets.database.passwordKey }}
    {{- if not .Values.postgresql.enabled }}
    - secretKey: {{ .Values.secrets.externalSecrets.database.hostKey }}
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.database.secretKey }}
        property: {{ .Values.secrets.externalSecrets.database.hostKey }}
    - secretKey: {{ .Values.secrets.externalSecrets.database.portKey }}
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.database.secretKey }}
        property: {{ .Values.secrets.externalSecrets.database.portKey }}
    - secretKey: {{ .Values.secrets.externalSecrets.database.databaseKey }}
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.database.secretKey }}
        property: {{ .Values.secrets.externalSecrets.database.databaseKey }}
    - secretKey: {{ .Values.secrets.externalSecrets.database.usernameKey }}
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.database.secretKey }}
        property: {{ .Values.secrets.externalSecrets.database.usernameKey }}
    {{- end }}
---
{{- if .Values.questdb.enabled }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-questdb
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ $secretStoreName }}
    kind: {{ $secretStoreKind }}
  target:
    name: {{ include "vm-x-ai.fullname" . }}-questdb
    creationPolicy: Owner
  data:
    - secretKey: {{ .Values.secrets.externalSecrets.questdb.passwordKey }}
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.questdb.secretKey }}
        property: {{ .Values.secrets.externalSecrets.questdb.passwordKey }}
---
{{- end }}
{{- if eq .Values.api.encryption.provider "libsodium" }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-libsodium
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ $secretStoreName }}
    kind: {{ $secretStoreKind }}
  target:
    name: {{ include "vm-x-ai.fullname" . }}-libsodium
    creationPolicy: Owner
  data:
    - secretKey: {{ .Values.secrets.externalSecrets.libsodium.encryptionKeyKey }}
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.libsodium.secretKey }}
        property: {{ .Values.secrets.externalSecrets.libsodium.encryptionKeyKey }}
---
{{- end }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-ui
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ $secretStoreName }}
    kind: {{ $secretStoreKind }}
  target:
    name: {{ include "vm-x-ai.fullname" . }}-ui
    creationPolicy: Owner
  data:
    - secretKey: {{ .Values.secrets.externalSecrets.ui.authSecretKey }}
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.ui.secretKey }}
        property: {{ .Values.secrets.externalSecrets.ui.authSecretKey }}
---
{{- if and .Values.api.oidcFederated.enabled .Values.api.oidcFederated.clientSecret }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-oidc-federated
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ $secretStoreName }}
    kind: {{ $secretStoreKind }}
  target:
    name: {{ include "vm-x-ai.fullname" . }}-oidc-federated
    creationPolicy: Owner
  data:
    - secretKey: {{ .Values.secrets.externalSecrets.oidcFederated.clientSecretKey }}
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.oidcFederated.secretKey }}
        property: {{ .Values.secrets.externalSecrets.oidcFederated.clientSecretKey }}
---
{{- end }}
{{- end }}

