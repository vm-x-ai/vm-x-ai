{{- if eq .Values.secrets.method "create" }}
{{- $existingDbSecret := lookup "v1" "Secret" .Release.Namespace (printf "%s-database" (include "vm-x-ai.fullname" .)) }}
{{- $existingQuestdbSecret := lookup "v1" "Secret" .Release.Namespace (printf "%s-questdb" (include "vm-x-ai.fullname" .)) }}
{{- $existingLibsodiumSecret := lookup "v1" "Secret" .Release.Namespace (printf "%s-libsodium" (include "vm-x-ai.fullname" .)) }}
{{- $existingUiSecret := lookup "v1" "Secret" .Release.Namespace (printf "%s-ui" (include "vm-x-ai.fullname" .)) }}
{{- $existingOidcSecret := lookup "v1" "Secret" .Release.Namespace (printf "%s-oidc-federated" (include "vm-x-ai.fullname" .)) }}
{{- $dbPassword := "" }}
{{- if and $existingDbSecret $existingDbSecret.data.password }}
{{- $dbPassword = $existingDbSecret.data.password | b64dec }}
{{- else }}
{{- $dbPassword = randAlphaNum 32 }}
{{- end }}
{{- $questdbPassword := "" }}
{{- if and $existingQuestdbSecret $existingQuestdbSecret.data.password }}
{{- $questdbPassword = $existingQuestdbSecret.data.password | b64dec }}
{{- else }}
{{- $questdbPassword = randAlphaNum 32 }}
{{- end }}
{{- $libsodiumKey := "" }}
{{- if and $existingLibsodiumSecret (index $existingLibsodiumSecret.data "encryption-key") }}
{{- $libsodiumKey = index $existingLibsodiumSecret.data "encryption-key" }}
{{- else }}
{{- $libsodiumKey = randBytes 32 | b64enc }}
{{- end }}
{{- $uiAuthSecret := "" }}
{{- if and $existingUiSecret (index $existingUiSecret.data "auth-secret") }}
{{- $uiAuthSecret = index $existingUiSecret.data "auth-secret" | b64dec }}
{{- else }}
{{- $uiAuthSecret = randAlphaNum 32 }}
{{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-database
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
type: Opaque
data:
  password: {{ $dbPassword | b64enc }}
  {{- if not .Values.postgresql.enabled }}
  host: {{ .Values.postgresql.external.host | b64enc }}
  port: {{ .Values.postgresql.external.port | toString | b64enc }}
  database: {{ .Values.postgresql.external.database | b64enc }}
  username: {{ .Values.postgresql.external.username | b64enc }}
  {{- end }}
---
{{- if .Values.questdb.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-questdb
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
type: Opaque
data:
  password: {{ $questdbPassword | b64enc }}
---
{{- end }}
{{- if eq .Values.api.encryption.provider "libsodium" }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-libsodium
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
type: Opaque
data:
  encryption-key: {{ $libsodiumKey }}
---
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-ui
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
type: Opaque
data:
  auth-secret: {{ $uiAuthSecret | b64enc }}
---
{{- if and (eq .Values.secrets.method "create") .Values.api.oidcFederated.enabled .Values.api.oidcFederated.clientSecret }}
{{- $oidcClientSecret := "" }}
{{- if and $existingOidcSecret (index $existingOidcSecret.data "client-secret") }}
{{- $oidcClientSecret = index $existingOidcSecret.data "client-secret" | b64dec }}
{{- else }}
{{- $oidcClientSecret = randAlphaNum 32 }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-oidc-federated
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
type: Opaque
data:
  client-secret: {{ $oidcClientSecret | b64enc }}
---
{{- end }}
{{- end }}
