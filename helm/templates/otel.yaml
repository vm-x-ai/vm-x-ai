{{- if .Values.otel.enabled }}
{{- if .Values.otel.collector.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-otel-collector-config
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: otel-collector
data:
  otel-collector-config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

    processors:
      batch:

    exporters:
    {{- if .Values.otel.jaeger.enabled }}
      otlp:
        endpoint: {{ include "vm-x-ai.fullname" . }}-jaeger:4317
        tls:
          insecure: true
    {{- end }}
    {{- if .Values.otel.prometheus.enabled }}
      prometheus:
        endpoint: 0.0.0.0:8889
    {{- end }}
    {{- if .Values.otel.loki.enabled }}
      otlphttp:
        endpoint: http://{{ include "vm-x-ai.fullname" . }}-loki:{{ .Values.otel.loki.service.port }}/otlp
    {{- end }}

    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [batch]
          exporters: [otlp]
    {{- if .Values.otel.prometheus.enabled }}
        metrics:
          receivers: [otlp]
          processors: [batch]
          exporters: [prometheus]
    {{- end }}
        logs:
          receivers: [otlp]
          processors: [batch]
    {{- if .Values.otel.loki.enabled }}
          exporters: [otlphttp]
    {{- end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-otel-collector
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: otel-collector
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "vm-x-ai.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: otel-collector
  template:
    metadata:
      annotations:
        {{- if not .Values.otel.istio.sidecar.enabled }}
        sidecar.istio.io/inject: "false"
        {{- end }}
      labels:
        {{- include "vm-x-ai.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: otel-collector
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
      - name: otel-collector
        image: {{ printf "%s:%s" .Values.otel.collector.image.repository .Values.otel.collector.image.tag }}
        imagePullPolicy: {{ .Values.otel.collector.image.pullPolicy }}
        command:
        - /otelcol-contrib
        - --config=/etc/otel-collector-config.yaml
        ports:
        {{- range .Values.otel.collector.service.ports }}
        - name: {{ .name }}
          containerPort: {{ .port }}
          protocol: TCP
        {{- end }}
        {{- if .Values.otel.prometheus.enabled }}
        - name: http-prometheus
          containerPort: 8889
          protocol: TCP
        {{- end }}
        volumeMounts:
        - name: config
          mountPath: /etc/otel-collector-config.yaml
          subPath: otel-collector-config.yaml
          readOnly: true
        resources:
          {{- toYaml .Values.otel.collector.resources | nindent 10 }}
      volumes:
      - name: config
        configMap:
          name: {{ include "vm-x-ai.fullname" . }}-otel-collector-config
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-otel-collector
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: otel-collector
spec:
  type: {{ .Values.otel.collector.service.type }}
  ports:
    {{- range .Values.otel.collector.service.ports }}
    - port: {{ .port }}
      targetPort: {{ .name }}
      protocol: TCP
      name: {{ .name }}
    {{- end }}
    {{- if .Values.otel.prometheus.enabled }}
    - port: 8889
      targetPort: http-prometheus
      protocol: TCP
      name: http-prometheus
    {{- end }}
  selector:
    {{- include "vm-x-ai.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: otel-collector
---
{{- end }}
{{- if .Values.otel.jaeger.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-jaeger
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: jaeger
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "vm-x-ai.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: jaeger
  template:
    metadata:
      annotations:
        {{- if not .Values.otel.istio.sidecar.enabled }}
        sidecar.istio.io/inject: "false"
        {{- end }}
      labels:
        {{- include "vm-x-ai.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: jaeger
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
      - name: jaeger
        image: {{ printf "%s:%s" .Values.otel.jaeger.image.repository .Values.otel.jaeger.image.tag }}
        imagePullPolicy: {{ .Values.otel.jaeger.image.pullPolicy }}
        env:
        - name: COLLECTOR_OTLP_ENABLED
          value: "true"
        ports:
        {{- range .Values.otel.jaeger.service.ports }}
        - name: {{ .name }}
          containerPort: {{ .port }}
          protocol: TCP
        {{- end }}
        resources:
          {{- toYaml .Values.otel.jaeger.resources | nindent 10 }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-jaeger
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: jaeger
spec:
  type: {{ .Values.otel.jaeger.service.type }}
  ports:
    {{- range .Values.otel.jaeger.service.ports }}
    - port: {{ .port }}
      targetPort: {{ .name }}
      protocol: TCP
      name: {{ .name }}
    {{- end }}
  selector:
    {{- include "vm-x-ai.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: jaeger
---
{{- end }}
{{- if .Values.otel.prometheus.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-prometheus
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: prometheus
spec:
  replicas: 1
  # Use Recreate strategy for single-replica deployments with ReadWriteOnce volumes
  # This ensures the old pod is fully terminated before the new one starts
  strategy:
    type: Recreate
  selector:
    matchLabels:
      {{- include "vm-x-ai.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: prometheus
  template:
    metadata:
      annotations:
        {{- if not .Values.otel.istio.sidecar.enabled }}
        sidecar.istio.io/inject: "false"
        {{- end }}
      labels:
        {{- include "vm-x-ai.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: prometheus
    spec:
      # Ensure proper termination to release volume locks
      terminationGracePeriodSeconds: 30
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
      - name: prometheus
        image: {{ printf "%s:%s" .Values.otel.prometheus.image.repository .Values.otel.prometheus.image.tag }}
        imagePullPolicy: {{ .Values.otel.prometheus.image.pullPolicy }}
        command:
        - prometheus
        - --config.file=/etc/prometheus/prometheus.yml
        - --storage.tsdb.path=/prometheus
        ports:
        - name: http
          containerPort: {{ .Values.otel.prometheus.service.port }}
          protocol: TCP
        volumeMounts:
        - name: config
          mountPath: /etc/prometheus
        - name: data
          mountPath: /prometheus
        resources:
          {{- toYaml .Values.otel.prometheus.resources | nindent 10 }}
      volumes:
      - name: config
        configMap:
          name: {{ include "vm-x-ai.fullname" . }}-prometheus-config
      - name: data
        {{- if .Values.otel.prometheus.persistence.enabled }}
        persistentVolumeClaim:
          claimName: {{ include "vm-x-ai.fullname" . }}-prometheus
        {{- else }}
        emptyDir: {}
        {{- end }}
---
{{- if .Values.otel.prometheus.persistence.enabled }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-prometheus
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: prometheus
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.otel.prometheus.persistence.size }}
  {{- if .Values.otel.prometheus.persistence.storageClass }}
  storageClassName: {{ .Values.otel.prometheus.persistence.storageClass }}
  {{- end }}
---
{{- end }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-prometheus-config
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: prometheus
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
      - job_name: 'vm-x-ai-api'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_component]
            action: keep
            regex: api
    {{- if .Values.otel.collector.enabled }}
      - job_name: 'otel-collector'
        static_configs:
          - targets: ['{{ include "vm-x-ai.fullname" . }}-otel-collector:8889']
    {{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-prometheus
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: prometheus
spec:
  type: {{ .Values.otel.prometheus.service.type }}
  ports:
    - port: {{ .Values.otel.prometheus.service.port }}
      targetPort: http
      protocol: TCP
      name: http
  selector:
    {{- include "vm-x-ai.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: prometheus
---
{{- end }}
{{- if .Values.otel.loki.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-loki
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: loki
spec:
  replicas: 1
  # Use Recreate strategy for single-replica deployments with ReadWriteOnce volumes
  # This ensures the old pod is fully terminated before the new one starts
  strategy:
    type: Recreate
  selector:
    matchLabels:
      {{- include "vm-x-ai.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: loki
  template:
    metadata:
      annotations:
        {{- if not .Values.otel.istio.sidecar.enabled }}
        sidecar.istio.io/inject: "false"
        {{- end }}
      labels:
        {{- include "vm-x-ai.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: loki
    spec:
      # Ensure proper termination to release volume locks
      terminationGracePeriodSeconds: 30
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
      - name: loki
        image: {{ printf "%s:%s" .Values.otel.loki.image.repository .Values.otel.loki.image.tag }}
        imagePullPolicy: {{ .Values.otel.loki.image.pullPolicy }}
        ports:
        - name: http
          containerPort: {{ .Values.otel.loki.service.port }}
          protocol: TCP
        volumeMounts:
        - name: data
          mountPath: /loki
        resources:
          {{- toYaml .Values.otel.loki.resources | nindent 10 }}
      volumes:
      - name: data
        {{- if .Values.otel.loki.persistence.enabled }}
        persistentVolumeClaim:
          claimName: {{ include "vm-x-ai.fullname" . }}-loki
        {{- else }}
        emptyDir: {}
        {{- end }}
---
{{- if .Values.otel.loki.persistence.enabled }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-loki
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: loki
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.otel.loki.persistence.size }}
  {{- if .Values.otel.loki.persistence.storageClass }}
  storageClassName: {{ .Values.otel.loki.persistence.storageClass }}
  {{- end }}
---
{{- end }}
apiVersion: v1
kind: Service
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-loki
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: loki
spec:
  type: {{ .Values.otel.loki.service.type }}
  ports:
    - port: {{ .Values.otel.loki.service.port }}
      targetPort: http
      protocol: TCP
      name: http
  selector:
    {{- include "vm-x-ai.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: loki
---
{{- end }}
{{- if .Values.otel.grafana.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-grafana-datasources
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: grafana
data:
  datasources.yaml: |
    apiVersion: 1

    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://{{ include "vm-x-ai.fullname" . }}-prometheus:{{ .Values.otel.prometheus.service.port }}
        isDefault: true
        editable: true
        jsonData:
          timeInterval: "15s"
{{- if .Values.otel.loki.enabled }}
      - name: Loki
        type: loki
        access: proxy
        url: http://{{ include "vm-x-ai.fullname" . }}-loki:{{ .Values.otel.loki.service.port }}
        editable: true
        jsonData:
          maxLines: 1000
{{- end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-grafana
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "vm-x-ai.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: grafana
  template:
    metadata:
      annotations:
        {{- if not .Values.otel.istio.sidecar.enabled }}
        sidecar.istio.io/inject: "false"
        {{- end }}
      labels:
        {{- include "vm-x-ai.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: grafana
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
      - name: grafana
        image: {{ printf "%s:%s" .Values.otel.grafana.image.repository .Values.otel.grafana.image.tag }}
        imagePullPolicy: {{ .Values.otel.grafana.image.pullPolicy }}
        ports:
        - name: http
          containerPort: {{ .Values.otel.grafana.service.port }}
          protocol: TCP
        volumeMounts:
        - name: data
          mountPath: /var/lib/grafana
        - name: datasources
          mountPath: /etc/grafana/provisioning/datasources
          readOnly: true
        resources:
          {{- toYaml .Values.otel.grafana.resources | nindent 10 }}
      volumes:
      - name: data
        {{- if .Values.otel.grafana.persistence.enabled }}
        persistentVolumeClaim:
          claimName: {{ include "vm-x-ai.fullname" . }}-grafana
        {{- else }}
        emptyDir: {}
        {{- end }}
      - name: datasources
        configMap:
          name: {{ include "vm-x-ai.fullname" . }}-grafana-datasources
---
{{- if .Values.otel.grafana.persistence.enabled }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-grafana
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: grafana
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.otel.grafana.persistence.size }}
  {{- if .Values.otel.grafana.persistence.storageClass }}
  storageClassName: {{ .Values.otel.grafana.persistence.storageClass }}
  {{- end }}
---
{{- end }}
apiVersion: v1
kind: Service
metadata:
  name: {{ include "vm-x-ai.fullname" . }}-grafana
  labels:
    {{- include "vm-x-ai.labels" . | nindent 4 }}
    app.kubernetes.io/component: grafana
spec:
  type: {{ .Values.otel.grafana.service.type }}
  ports:
    - port: {{ .Values.otel.grafana.service.port }}
      targetPort: http
      protocol: TCP
      name: http
  selector:
    {{- include "vm-x-ai.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: grafana
---
{{- end }}
{{- end }}

