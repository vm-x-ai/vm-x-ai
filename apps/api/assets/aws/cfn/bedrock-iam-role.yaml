AWSTemplateFormatVersion: '2010-09-09'
Description: 'Creates an IAM role for integrating VM-X AI with AWS Bedrock.'

Parameters:
  RoleName:
    Description: 'The name of the role.'
    Type: String
  ExternalID:
    Description: 'The external ID that must be used by the assuming account.'
    Type: String
    NoEcho: true

Resources:
  BedrockRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Ref RoleName
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action: 'sts:AssumeRole'
            Condition:
              StringEquals:
                sts:ExternalId: !Ref ExternalID
      Path: /
      Description: 'Role for integrating VM-X AI with AWS Bedrock.'
      Policies:
        - PolicyName: Bedrock
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                Resource: '*'
                Effect: Allow
                Sid: BedrockInvokeModel
Outputs:
  RoleId:
    Description: 'The ID of the VM-X AI bedrock integration role.'
    Value: !Ref BedrockRole
  RoleArn:
    Description: 'The ARN of the VM-X AI bedrock integration role.'
    Value: !GetAtt BedrockRole.Arn
